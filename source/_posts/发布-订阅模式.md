---
title: 发布-订阅模式
date: 2022-6-22
---

### 发布-订阅模式

#### 定义

发布-订阅模式其实是一种对象间一对多的依赖关系，当一个对象的状态发送改变时，所有依赖于它的对象都将得到状态改变的通知。

订阅者（Subscriber）把自己想订阅的事件注册（Subscribe）到调度中心（Event Channel），当发布者（Publisher）发布该事件（Publish Event）到调度中心，也就是该事件触发时，由调度中心统一调度（Fire Event）订阅者注册到调度中心的处理代码。

**简单来说就是类似于微信公众号订阅，订阅了之后所有订阅者都能收到更新**

#### 特点

1. 可以**跨组件**运行
2. 创建订阅需要消耗内存和时间

#### 思路

1. 创建一个对象
2. 在该对象上创建一个缓存列表（调度中心）
3. on 方法用来把函数 fn 都加到缓存列表中（订阅者注册事件到调度中心）
4. emit 方法取到 arguments 里第一个当做 event，根据 event 值去执行对应缓存列表中的函数（发布者发布事件到调度中心，调度中心处理代码）
5. off 方法可以根据 event 值取消订阅（取消订阅）

#### 简易实现

```js
const eventHub = {
  // 创建对象
  map: {
    // click: [f1 , f2]
  },
  on: (name, fn) => {
    eventHub.map[name] = eventHub.map[name] || []; //检查之前是否存在name的订阅，如果存在那不变，不存在的话创建空数组
    eventHub.map[name].push(fn); //把fn放到数组里
  },
  emit: (name, data) => {
    //
    const fnList = eventHub.map[name];
    if (!fnList) return; //如果不存在订阅，那么直接return
    q.map((f) => f.call(null, data)); //传入data运行
    return undefined;
  },
  off: (name, fn) => {
    const fnList = eventHub.map[name];
    if (!fnList) {
      return;
    } //如果q不存在，那么直接return
    const index = fnList.indexOf(fn); //找到fn
    if (index < 0) {
      return;
    } //如果fn不存在，return
    fnList.splice(index, 1); //把fn移除
  },
};

eventHub.on("click", console.log);
eventHub.on("click", console.error);

setTimeout(() => {
  eventHub.emit("click", "Rick");
}, 3000);
```

也可以用 class 实现

```js
class EventHub {
  map = {
    // click: [f1 , f2]
  };
  on(name, fn) {
    this.map[name] = this.map[name] || [];
    this.map[name].push(fn);
  }
  emit(name, data) {
    const fnList = this.map[name] || [];
    fnList.forEach((fn) => fn.call(undefined, data));
  }
  off(name, fn) {
    const fnList = this.map[name] || [];
    const index = fnList.indexOf(fn);
    if (index < 0) return;
    fnList.splice(index, 1);
  }
}

const e = new EventHub();
e.on("click", (name) => {
  console.log("hi " + name);
});
e.on("click", (name) => {
  console.log("hello " + name);
});
setTimeout(() => {
  e.emit("click", "Rick");
}, 3000);
```
